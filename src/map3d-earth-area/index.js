const Cube = require('@/Cube')(module, module.exports, require);
Cube("datav:/com/map3d-earth-area/0.0.16",["datav:/npm/chroma-js/1.3.4","datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=200,j=null,k=null,l=require("chroma-js"),i=require("eventemitter3"),m=require("safely-merge"),n=require("@/map3d-earth-area/geojson2extrude"),o=require("@/map3d-earth-area/geojson2extrudeline"),p=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=m({visible:!0,height:2,isStokeOnly:!0,strokeWidth:0.05,strokeColor:"#E7EE98",strokeOpacity:1,minFillColor:"#33C9FB",maxFillColor:"#1F68A7",defaultFillColor:"#676767",fillOpacity:1,chinaGeoJsonApi:"//sh-conf.oss-cn-shanghai.aliyuncs.com/datav-coms-data/china.json",getId:function(a){return a.id||a.adcode||a.ad_code||a.name},getValue:function(a){return void 0===a.value?0:a.value}},c||{}),f.areaData=null,f.geoJsonData=null,f.code2value=null,f.colorScale=null,f.renderOrderIndex=10+Math.round(90*Math.random()),f}return f(b,a),g(b,[{key:"addTo",value:function(a){return a?void(j=a.THREE,this.map=a,k=a.Utils,this.scene=a.scene,this.map.on("projChanged",this.updatePostions.bind(this)),this.initMaterial()):console.log("areas layer needs map layer")}},{key:"initMaterial",value:function(){var a=this.options,b=a.strokeColor,c=a.defaultFillColor;this.areaMaterial=this.getMaterial(),this.strokeMaterial=this.getMaterial(),this.fillColor=l(c).gl(),this.strokeColor=l(b).gl()}},{key:"getMaterial",value:function(){return new j.ShaderMaterial({uniforms:{u_ease_index:{value:1},u_proj_type:{value:this.map.projType}},vertexShader:require("@/map3d-earth-area/shader/vert.glsl"),fragmentShader:require("@/map3d-earth-area/shader/frag.glsl"),side:j.DoubleSide,blending:j.NormalBlending,depthTest:!0,depthWrite:!0,transparent:!0})}},{key:"setData",value:function(a){return a&&Array.isArray(a)?void(this.areaData=a,!this.options.isStokeOnly&&this.colorify()):console.log("area layer no area data")}},{key:"setGeojson",value:function(a){var b=this;a&&a.features&&Array.isArray(a.features)&&0<a.features.length?(this.geoJsonData=a,this.render()):fetch(this.options.chinaGeoJsonApi).then(function(a){return a.json()}).then(function(a){b.geoJsonData=a,console.log("\u4F7F\u7528\u9ED8\u8BA4\u7684geojson"),b.render()}).catch(function(a){return console.log("fetch error",a)})}},{key:"render",value:function(){this.clean(),this.initMaterial(),this.renderStroke(),this.options.isStokeOnly||(this.renderArea(),this.colorify()),this.checkVisible()}},{key:"colorify",value:function(){if(this.areaData){this.getValueRange(this.areaData);var a=this.options.defaultFillColor;if(this.fillColor=l(a).gl(),this.areaKeyIndex&&this.geometryArea&&this.colorScale&&this.code2value){var b=this.geometryArea.attributes.aColor.array;for(var c in this.areaKeyIndex){var d=this.areaKeyIndex[c],e=null;if(e=void 0===this.code2value[c]?this.fillColor:this.colorScale(this.code2value[c]).gl(),d)for(var f=d[0];f<d[1];f++)b[4*f+0]=e[0],b[4*f+1]=e[1],b[4*f+2]=e[2],b[4*f+3]=this.options.fillOpacity}this.geometryArea.attributes.aColor.needsUpdate=!0}}}},{key:"getValueRange",value:function(a){var b=null,c=null;this.code2value={};for(var e=this.options,f=0;f<a.length;f++){var g=a[f],d=e.getId(g),h=e.getValue(g);this.code2value[d]||(this.code2value[d]=h),(null===c||void 0===c)&&(c=h),(null===b||void 0===b)&&(b=h),c>h&&(c=h),b<h&&(b=h)}null!==c&&null!==b&&(this.colorScale=l.scale([e.minFillColor,e.maxFillColor]).domain([c,b]))}},{key:"renderArea",value:function(){if(this.geoJsonData){for(var a=this.options,b=this.geoJsonData,c=n(b,{project:k,getRMax:function(){return h+a.height},getRMin:function(){return h+a.height},getKey:function(a){return a.properties.id||a.properties.adcode||a.properties.ad_code||a.properties.name}}),d=[],e=0;e<c.spherePositions.length/3;e++)d[4*e+0]=this.fillColor[0],d[4*e+1]=this.fillColor[1],d[4*e+2]=this.fillColor[2],d[4*e+3]=a.fillOpacity;var f=this.geometryArea=new j.BufferGeometry;f.setIndex(new j.BufferAttribute(new Uint32Array(c.indices_array),1)),f.addAttribute("sphere_position",new j.BufferAttribute(new Float32Array(c.spherePositions),3).setDynamic(!0)),f.addAttribute("plane_position",new j.BufferAttribute(new Float32Array(c.planePositions),3).setDynamic(!0)),f.addAttribute("aColor",new j.BufferAttribute(new Float32Array(d),4).setDynamic(!0)),f.setDrawRange(0,c.spherePositions.length),f.computeBoundingSphere(),f.computeBoundingBox(),this.areaKeyIndex=c.key_index,this.meshArea=new j.Mesh(f,this.areaMaterial),this.meshArea.renderOrder=this.renderOrderIndex,this.scene.add(this.meshArea)}}},{key:"renderStroke",value:function(){if(this.geoJsonData){for(var a=this.options,b=this.geoJsonData,c=o(b,{project:k,getR:function(){return h+a.height},getThickness:function(){return a.strokeWidth},getKey:function(a){return a.properties.id||a.properties.adcode||a.properties.ad_code||a.properties.name}}),d=[],e=0;e<c.spherePositions.length/3;e++)d[4*e+0]=this.strokeColor[0],d[4*e+1]=this.strokeColor[1],d[4*e+2]=this.strokeColor[2],d[4*e+3]=a.strokeOpacity;var f=this.geometryStroke=new j.BufferGeometry;f.setIndex(new j.BufferAttribute(new Uint32Array(c.index),1)),f.addAttribute("sphere_position",new j.BufferAttribute(new Float32Array(c.spherePositions),3).setDynamic(!0)),f.addAttribute("plane_position",new j.BufferAttribute(new Float32Array(c.planePositions),3).setDynamic(!0)),f.addAttribute("uv",new j.BufferAttribute(new Float32Array(c.uv),3)),f.addAttribute("aColor",new j.BufferAttribute(new Float32Array(d),4)),f.setDrawRange(0,c.spherePositions.length),f.computeBoundingSphere(),f.computeBoundingBox(),this.strokeKeyIndex=c.key_index,this.meshStroke=new j.Mesh(f,this.strokeMaterial),this.meshStroke.renderOrder=this.renderOrderIndex+1,this.scene.add(this.meshStroke)}}},{key:"updateOptions",value:function(a){var b=this.options.height,c=this.options.strokeWidth,d=this.options.isStokeOnly;this.options=m(this.options,a||{}),b!==a.height||c!==a.strokeWidth||d!==a.isStokeOnly?this.render():this.colorify(),this.updateStroke(),this.checkVisible()}},{key:"updatePostions",value:function(a){var b=a.projType,c=a.index;this.areaMaterial.uniforms.u_ease_index.value=c,this.areaMaterial.uniforms.u_proj_type.value=b,this.strokeMaterial.uniforms.u_ease_index.value=c,this.strokeMaterial.uniforms.u_proj_type.value=b}},{key:"updateStroke",value:function(){for(var a=this.options,b=a.strokeOpacity,c=l(a.strokeColor).gl(),d=this.geometryStroke.attributes.aColor.array,e=0;e<d.length/4;e++)d[4*e+0]=c[0],d[4*e+1]=c[1],d[4*e+2]=c[2],d[4*e+3]=b;this.geometryStroke.attributes.aColor.needsUpdate=!0}},{key:"checkVisible",value:function(){var a=this.options;a.visible?this.show():this.hide()}},{key:"hide",value:function(){this.options.visible=!1,this.meshArea&&(this.meshArea.visible=!1),this.meshStroke&&(this.meshStroke.visible=!1)}},{key:"show",value:function(){this.options.visible=!0,this.meshArea&&(this.meshArea.visible=!0),this.meshStroke&&(this.meshStroke.visible=!0)}},{key:"clean",value:function(){this.meshArea&&this.scene.remove(this.meshArea),this.meshArea&&this.meshArea.dispose&&this.meshArea.dispose(),this.geometryArea&&this.geometryArea.dispose&&this.geometryArea.dispose(),this.areaMaterial&&this.areaMaterial.dispose&&this.areaMaterial.dispose(),this.meshStroke&&this.scene.remove(this.meshStroke),this.meshStroke&&this.meshStroke.dispose&&this.meshStroke.dispose(),this.geometryStroke&&this.geometryStroke.dispose&&this.geometryStroke.dispose(),this.strokeMaterial&&this.strokeMaterial.dispose&&this.strokeMaterial.dispose()}},{key:"remove",value:function(){this.map.off("projChanged",this.updatePostions),this.meshArea&&this.scene.remove(this.meshArea),this.meshArea&&this.meshArea.dispose&&this.meshArea.dispose(),this.geometryArea&&this.geometryArea.dispose&&this.geometryArea.dispose(),this.areaMaterial&&this.areaMaterial.dispose&&this.areaMaterial.dispose(),this.meshStroke&&this.scene.remove(this.meshStroke),this.meshStroke&&this.meshStroke.dispose&&this.meshStroke.dispose(),this.geometryStroke&&this.geometryStroke.dispose&&this.geometryStroke.dispose(),this.strokeMaterial&&this.strokeMaterial.dispose&&this.strokeMaterial.dispose(),this.areaData=null,this.geoJsonData=null,this.code2value=null,this.colorScale=null,this.meshArea=null,this.geometryArea=null,this.areaMaterial=null,this.meshStroke=null,this.geometryStroke=null,this.strokeMaterial=null}}]),b}(i);return a.exports=p,a.exports});