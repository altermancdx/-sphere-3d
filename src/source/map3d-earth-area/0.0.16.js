Cube("datav:/com/map3d-earth-area/0.0.16/extrude-line",["datav:/npm/gl-vec2/1.0.0/distance","datav:/npm/gl-vec2/1.0.0/copy","datav:/npm/gl-vec2/1.0.0/scaleAndAdd","datav:/npm/gl-vec2/1.0.0/dot","datav:/npm/as-number/1.0.0","datav:/npm/polyline-miter-util/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f={create:function(){return[0,0]},distance:c("datav:/npm/gl-vec2/1.0.0/distance"),clone:function(a){return[a[0],a[1]]},copy:c("datav:/npm/gl-vec2/1.0.0/copy"),scaleAndAdd:c("datav:/npm/gl-vec2/1.0.0/scaleAndAdd"),dot:c("datav:/npm/gl-vec2/1.0.0/dot")},g=c("datav:/npm/as-number/1.0.0"),h=f.create(),i=f.create(),j=f.create(),k=f.create(),l=f.create(),m=f.create(),n=c("datav:/npm/polyline-miter-util/1.0.1");_sphereProject=null,_planeProject=null,_R=null;var o=n.computeMiter,p=n.normal,q=n.direction,r=function(){function a(b){d(this,a),b=b||{},this.miterLimit=g(b.miterLimit,10),this.thickness=g(b.thickness,1),this.join=b.join||"miter",this.cap=b.cap||"butt",this._normal=null,this._lastFlip=-1,this._started=!1,_R=b.R,_sphereProject=b.project.ll2sphere,_planeProject=b.project.ll2plane}return e(a,[{key:"mapThickness",value:function(){return this.thickness}},{key:"sphereProject",value:function(a){var b=_sphereProject(a[0],a[1],_R);return[b.x,b.y,b.z]}},{key:"planeProject",value:function(a){var b=_planeProject(a[0],a[1],_R);return[b.x,b.y,b.z]}},{key:"build",value:function(a){var b={spherePositions:[],planePositions:[],cells:[],uvs:[]};if(1>=a.length)return b;var c=a.length;this._lastFlip=-1,this._started=!1,this._normal=null;for(var d=0,e=0;e<c-1;e++)d+=f.distance(a[e],a[e+1]);for(var g=0,h=1,i=0;h<c;h++){var j=a[h-1],k=a[h],l=h<a.length-1?a[h+1]:null,m=this.mapThickness(k,h,a);g+=f.distance(j,k)/d;var n=this._seg(b,i,j,k,l,m/2,g);i+=n}return b}},{key:"_seg",value:function(a,b,c,d,e,g,n){var r=0,s=a.cells,t=a.planePositions,u=a.spherePositions,v=a.uvs,w="square"===this.cap,x="bevel"===this.join;if(q(j,d,c),this._normal||(this._normal=f.create(),p(this._normal,j)),this._started||(this._started=!0,w&&(f.scaleAndAdd(i,c,j,-g),c=i),this.extrusions(t,v,c,this._normal,g,0,this.planeProject),this.extrusions(u,v,c,this._normal,g,0,this.sphereProject)),s.push(b+0,b+1,b+2),!e)p(this._normal,j),w&&(f.scaleAndAdd(i,d,j,g),d=i),this.extrusions(t,v,c,this._normal,g,1,this.planeProject),this.extrusions(u,v,c,this._normal,g,1,this.sphereProject),[].push.apply(s,1===this._lastFlip?[b,b+2,b+3]:[b+2,b+1,b+3]),r+=2;else{q(k,e,d);var y=o(l,m,j,k,g),z=0>f.dot(l,this._normal)?-1:1,A=x;if(!A&&"miter"===this.join){y/g>this.miterLimit&&(A=!0)}A?(f.scaleAndAdd(h,d,this._normal,-g*z),[].push.apply(u,this.sphereProject(f.clone(h))),[].push.apply(t,this.planeProject(f.clone(h))),v.push(n,1),f.scaleAndAdd(h,d,m,y*z),[].push.apply(u,this.sphereProject(f.clone(h))),[].push.apply(t,this.planeProject(f.clone(h))),v.push(n,0),[].push.apply(s,this._lastFlip===-z?[b+2,b+1,b+3]:[b,b+2,b+3]),s.push(b+2,b+3,b+4),p(h,k),f.copy(this._normal,h),f.scaleAndAdd(h,d,h,-g*z),[].push.apply(u,this.sphereProject(f.clone(h))),[].push.apply(t,this.planeProject(f.clone(h))),v.push(n,0),r+=3):(this.extrusions(t,v,d,m,y,n,this.planeProject),this.extrusions(u,v,d,m,y,n,this.sphereProject),[].push.apply(s,1===this._lastFlip?[b,b+2,b+3]:[b+2,b+1,b+3]),z=-1,f.copy(this._normal,m),r+=2),this._lastFlip=z}return r}},{key:"extrusions",value:function(a,b,c,d,e,g,i){f.scaleAndAdd(h,c,d,-e),[].push.apply(a,i(f.clone(h))),b.push(g,1),f.scaleAndAdd(h,c,d,e),[].push.apply(a,i(f.clone(h))),b.push(g,0)}}]),a}();return a.exports=function(a,b){var c=new r(b);return c.build(a)},a.exports});;
Cube("datav:/com/map3d-earth-area/0.0.16/geojson2extrudeline",[],function(a,b,c){var d=c("datav:/com/map3d-earth-area/0.0.16/extrude-line");return a.exports=function(a,b){var c={getR:function(){return 200+0.01},getThickness:function(){return 0.05},getCap:function(){return"square"},getJoin:function(){return"bevel"},getMiterLimit:function(){return 0.2},getKey:function(a){return a.properties.id||a.properties.adcode}};Object.assign(c,b);for(var e,f={spherePositions:[],planePositions:[],uv:[],index:[],key_index:{}},g=a.features,h=function(a){var b=g[a],e=[];if(!b.geometry)return"continue";switch(b.geometry.type){case"MultiLineString":[].push.apply(e,b.geometry.coordinates);break;case"LineString":e.push(b.geometry.coordinates);break;case"Polygon":[].push.apply(e,b.geometry.coordinates);break;case"MultiPolygon":b.geometry.coordinates.forEach(function(a){[].push.apply(e,a)});break;default:}for(var h=f.spherePositions.length/3,j=function(g){var h=e[g],i=f.spherePositions.length/3,j={project:c.project,R:c.getR(b,a),thickness:c.getThickness(b,a),cap:c.getCap(b,a),join:c.getJoin(b,a),miterLimit:c.getMiterLimit(b,a)},k=d(h,j);k.spherePositions.map(function(a){return f.spherePositions.push(a)}),k.planePositions.map(function(a){return f.planePositions.push(a)}),k.uvs.map(function(a){return f.uv.push(a)});var l=k.cells.map(function(a){return a+i});l.map(function(a){return f.index.push(a)})},k=0;k<e.length;k++)j(k);var i=f.spherePositions.length/3,l=c.getKey(b,a);f.key_index[l]={range:[h,i],userData:b.properties}},i=0;i<g.length;i++)e=h(i),"continue"===e;return f},a.exports});;
Cube("datav:/com/map3d-earth-area/0.0.16/shader/frag.glsl",[],function(a){return a.exports="#define GLSLIFY 1\n varying vec4 vColor;\n\nvoid main() {\n  gl_FragColor = vColor;\n}",a.exports});;
Cube("datav:/com/map3d-earth-area/0.0.16/extruder.js",["datav:/npm/earcut/2.1.2","datav:/npm/geojson-bbox/0.0.0"],function(a,b,c){var d=c("datav:/npm/earcut/2.1.2"),e=c("datav:/npm/geojson-bbox/0.0.0");return a.exports=function(a,b){b=Object.assign({rMax:205,rMin:201,project:null,closed:!0},b);var c=d.flatten(a),f=c.vertices,g=f.length/2,h=[],j=[],k=[],l=[],m=d(c.vertices,c.holes,c.dimensions);if(b.rMax===b.rMin){var n=e({type:"Polygon",coordinates:a}),o=n[2]-n[0],p=n[3]-n[1];f.forEach(function(a,d){if(0===d%c.dimensions){var e=b.project.ll2sphere(f[d],f[d+1],b.rMax);h.push(e.x,e.y,e.z);var g=b.project.ll2plane(f[d],f[d+1],b.rMax);j.push(g.x,g.y,g.z),k.push((f[d]-n[0])/o,(f[d+1]-n[1])/p)}}),l=m}else{var q=[],r=[];f.forEach(function(a,d){if(0===d%c.dimensions){var e=b.project.ll2sphere(f[d],f[d+1],b.rMin),g=b.project.ll2sphere(f[d],f[d+1],b.rMax);h.push(e.x,e.y,e.z),q.push(g.x,g.y,g.z);var i=b.project.ll2plane(f[d],f[d+1],b.rMin),k=b.project.ll2plane(f[d],f[d+1],b.rMax);j.push(i.x,i.y,i.z),r.push(k.x,k.y,k.z)}}),[].push.apply(h,q),[].push.apply(j,r);for(var s=0;s<g;s++)s===g-1?l.push(s+g,g,s,0,s,g):l.push(s+g,s+g+1,s,s+1,s,s+g+1);b.closed&&([].push.apply(l,m),m.forEach(function(a,b){0===b%3&&l.push(m[b+0]+g,m[b+2]+g,m[b+1]+g)}))}return{planePositions:j,spherePositions:h,uvs:k,cells:l,cellsLen:l.length,positionsLen:j.length}},a.exports});;
Cube("datav:/com/map3d-earth-area/0.0.16/shader/vert.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nattribute vec4 aColor;\nattribute vec3 plane_position;\nattribute vec3 sphere_position;\n\nvarying vec4 vColor;\n\nuniform float u_proj_type;\nuniform float u_ease_index;\n\nvec3 real_position() {\n  if(u_proj_type == 0.){\n    return mix(plane_position, sphere_position, u_ease_index);\n  } else if(u_proj_type == 1.){\n     return mix(sphere_position, plane_position, u_ease_index);\n  } else {\n    return vec3(0);\n  }\n  \n}\n\nvoid main() {\n  vColor = aColor;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( real_position(), 1.0 );\n}",a.exports});;
Cube("datav:/com/map3d-earth-area/0.0.16/geojson2extrude",["datav:/npm/earcut/2.1.2"],function(a,b,c){var d=c("datav:/npm/earcut/2.1.2"),e=c("datav:/com/map3d-earth-area/0.0.16/extruder.js");return a.exports=function(a,b){var c={getRMax:function(a){return a.properties.floor||a.properties.height||0},getRMin:function(){return 200},getKey:function(a){return a.properties.id||a.properties.adcode||a.properties.ad_code||a.properties.name},getVertexColor:function(){return[0,0,0,1]}};Object.assign(c,b);for(var d=[],f=[],g=[],h=[],i={},j=a.features,k=function(a){var b=j[a],k=[],l=c.getRMax(b,a),m=c.getRMin(b,a);if(b.geometry){"MultiPolygon"===b.geometry.type?[].push.apply(k,b.geometry.coordinates):"Polygon"===b.geometry.type&&k.push(b.geometry.coordinates);var n=d.length/3;k.forEach(function(a){var b=d.length/3,i=e(a,{rMax:l,rMin:m,project:c.project});[].push.apply(f,i.planePositions),[].push.apply(d,i.spherePositions),[].push.apply(g,i.uvs);var j=i.cells,k=j.map(function(a){return a+b});[].push.apply(h,k)});var o=d.length/3,p=c.getKey(b,a);p&&(i[p]=[n,o])}},l=0,m=j.length;l<m;l++)k(l,m);return{planePositions:f,spherePositions:d,uvs:g,indices_array:h,key_index:i}},a.exports});;
Cube("datav:/com/map3d-earth-area/0.0.16",["datav:/npm/chroma-js/1.3.4","datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=200,j=null,k=null,l=c("datav:/npm/chroma-js/1.3.4"),i=c("datav:/npm/eventemitter3/2.0.3"),m=c("datav:/npm/safely-merge/1.0.1"),n=c("datav:/com/map3d-earth-area/0.0.16/geojson2extrude"),o=c("datav:/com/map3d-earth-area/0.0.16/geojson2extrudeline"),p=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=m({visible:!0,height:2,isStokeOnly:!0,strokeWidth:0.05,strokeColor:"#E7EE98",strokeOpacity:1,minFillColor:"#33C9FB",maxFillColor:"#1F68A7",defaultFillColor:"#676767",fillOpacity:1,chinaGeoJsonApi:"//sh-conf.oss-cn-shanghai.aliyuncs.com/datav-coms-data/china.json",getId:function(a){return a.id||a.adcode||a.ad_code||a.name},getValue:function(a){return void 0===a.value?0:a.value}},c||{}),f.areaData=null,f.geoJsonData=null,f.code2value=null,f.colorScale=null,f.renderOrderIndex=10+Math.round(90*Math.random()),f}return f(b,a),g(b,[{key:"addTo",value:function(a){return a?void(j=a.THREE,this.map=a,k=a.Utils,this.scene=a.scene,this.map.on("projChanged",this.updatePostions.bind(this)),this.initMaterial()):console.log("areas layer needs map layer")}},{key:"initMaterial",value:function(){var a=this.options,b=a.strokeColor,c=a.defaultFillColor;this.areaMaterial=this.getMaterial(),this.strokeMaterial=this.getMaterial(),this.fillColor=l(c).gl(),this.strokeColor=l(b).gl()}},{key:"getMaterial",value:function(){return new j.ShaderMaterial({uniforms:{u_ease_index:{value:1},u_proj_type:{value:this.map.projType}},vertexShader:c("datav:/com/map3d-earth-area/0.0.16/shader/vert.glsl"),fragmentShader:c("datav:/com/map3d-earth-area/0.0.16/shader/frag.glsl"),side:j.DoubleSide,blending:j.NormalBlending,depthTest:!0,depthWrite:!0,transparent:!0})}},{key:"setData",value:function(a){return a&&Array.isArray(a)?void(this.areaData=a,!this.options.isStokeOnly&&this.colorify()):console.log("area layer no area data")}},{key:"setGeojson",value:function(a){var b=this;a&&a.features&&Array.isArray(a.features)&&0<a.features.length?(this.geoJsonData=a,this.render()):fetch(this.options.chinaGeoJsonApi).then(function(a){return a.json()}).then(function(a){b.geoJsonData=a,console.log("\u4F7F\u7528\u9ED8\u8BA4\u7684geojson"),b.render()}).catch(function(a){return console.log("fetch error",a)})}},{key:"render",value:function(){this.clean(),this.initMaterial(),this.renderStroke(),this.options.isStokeOnly||(this.renderArea(),this.colorify()),this.checkVisible()}},{key:"colorify",value:function(){if(this.areaData){this.getValueRange(this.areaData);var a=this.options.defaultFillColor;if(this.fillColor=l(a).gl(),this.areaKeyIndex&&this.geometryArea&&this.colorScale&&this.code2value){var b=this.geometryArea.attributes.aColor.array;for(var c in this.areaKeyIndex){var d=this.areaKeyIndex[c],e=null;if(e=void 0===this.code2value[c]?this.fillColor:this.colorScale(this.code2value[c]).gl(),d)for(var f=d[0];f<d[1];f++)b[4*f+0]=e[0],b[4*f+1]=e[1],b[4*f+2]=e[2],b[4*f+3]=this.options.fillOpacity}this.geometryArea.attributes.aColor.needsUpdate=!0}}}},{key:"getValueRange",value:function(a){var b=null,c=null;this.code2value={};for(var e=this.options,f=0;f<a.length;f++){var g=a[f],d=e.getId(g),h=e.getValue(g);this.code2value[d]||(this.code2value[d]=h),(null===c||void 0===c)&&(c=h),(null===b||void 0===b)&&(b=h),c>h&&(c=h),b<h&&(b=h)}null!==c&&null!==b&&(this.colorScale=l.scale([e.minFillColor,e.maxFillColor]).domain([c,b]))}},{key:"renderArea",value:function(){if(this.geoJsonData){for(var a=this.options,b=this.geoJsonData,c=n(b,{project:k,getRMax:function(){return h+a.height},getRMin:function(){return h+a.height},getKey:function(a){return a.properties.id||a.properties.adcode||a.properties.ad_code||a.properties.name}}),d=[],e=0;e<c.spherePositions.length/3;e++)d[4*e+0]=this.fillColor[0],d[4*e+1]=this.fillColor[1],d[4*e+2]=this.fillColor[2],d[4*e+3]=a.fillOpacity;var f=this.geometryArea=new j.BufferGeometry;f.setIndex(new j.BufferAttribute(new Uint32Array(c.indices_array),1)),f.addAttribute("sphere_position",new j.BufferAttribute(new Float32Array(c.spherePositions),3).setDynamic(!0)),f.addAttribute("plane_position",new j.BufferAttribute(new Float32Array(c.planePositions),3).setDynamic(!0)),f.addAttribute("aColor",new j.BufferAttribute(new Float32Array(d),4).setDynamic(!0)),f.setDrawRange(0,c.spherePositions.length),f.computeBoundingSphere(),f.computeBoundingBox(),this.areaKeyIndex=c.key_index,this.meshArea=new j.Mesh(f,this.areaMaterial),this.meshArea.renderOrder=this.renderOrderIndex,this.scene.add(this.meshArea)}}},{key:"renderStroke",value:function(){if(this.geoJsonData){for(var a=this.options,b=this.geoJsonData,c=o(b,{project:k,getR:function(){return h+a.height},getThickness:function(){return a.strokeWidth},getKey:function(a){return a.properties.id||a.properties.adcode||a.properties.ad_code||a.properties.name}}),d=[],e=0;e<c.spherePositions.length/3;e++)d[4*e+0]=this.strokeColor[0],d[4*e+1]=this.strokeColor[1],d[4*e+2]=this.strokeColor[2],d[4*e+3]=a.strokeOpacity;var f=this.geometryStroke=new j.BufferGeometry;f.setIndex(new j.BufferAttribute(new Uint32Array(c.index),1)),f.addAttribute("sphere_position",new j.BufferAttribute(new Float32Array(c.spherePositions),3).setDynamic(!0)),f.addAttribute("plane_position",new j.BufferAttribute(new Float32Array(c.planePositions),3).setDynamic(!0)),f.addAttribute("uv",new j.BufferAttribute(new Float32Array(c.uv),3)),f.addAttribute("aColor",new j.BufferAttribute(new Float32Array(d),4)),f.setDrawRange(0,c.spherePositions.length),f.computeBoundingSphere(),f.computeBoundingBox(),this.strokeKeyIndex=c.key_index,this.meshStroke=new j.Mesh(f,this.strokeMaterial),this.meshStroke.renderOrder=this.renderOrderIndex+1,this.scene.add(this.meshStroke)}}},{key:"updateOptions",value:function(a){var b=this.options.height,c=this.options.strokeWidth,d=this.options.isStokeOnly;this.options=m(this.options,a||{}),b!==a.height||c!==a.strokeWidth||d!==a.isStokeOnly?this.render():this.colorify(),this.updateStroke(),this.checkVisible()}},{key:"updatePostions",value:function(a){var b=a.projType,c=a.index;this.areaMaterial.uniforms.u_ease_index.value=c,this.areaMaterial.uniforms.u_proj_type.value=b,this.strokeMaterial.uniforms.u_ease_index.value=c,this.strokeMaterial.uniforms.u_proj_type.value=b}},{key:"updateStroke",value:function(){for(var a=this.options,b=a.strokeOpacity,c=l(a.strokeColor).gl(),d=this.geometryStroke.attributes.aColor.array,e=0;e<d.length/4;e++)d[4*e+0]=c[0],d[4*e+1]=c[1],d[4*e+2]=c[2],d[4*e+3]=b;this.geometryStroke.attributes.aColor.needsUpdate=!0}},{key:"checkVisible",value:function(){var a=this.options;a.visible?this.show():this.hide()}},{key:"hide",value:function(){this.options.visible=!1,this.meshArea&&(this.meshArea.visible=!1),this.meshStroke&&(this.meshStroke.visible=!1)}},{key:"show",value:function(){this.options.visible=!0,this.meshArea&&(this.meshArea.visible=!0),this.meshStroke&&(this.meshStroke.visible=!0)}},{key:"clean",value:function(){this.meshArea&&this.scene.remove(this.meshArea),this.meshArea&&this.meshArea.dispose&&this.meshArea.dispose(),this.geometryArea&&this.geometryArea.dispose&&this.geometryArea.dispose(),this.areaMaterial&&this.areaMaterial.dispose&&this.areaMaterial.dispose(),this.meshStroke&&this.scene.remove(this.meshStroke),this.meshStroke&&this.meshStroke.dispose&&this.meshStroke.dispose(),this.geometryStroke&&this.geometryStroke.dispose&&this.geometryStroke.dispose(),this.strokeMaterial&&this.strokeMaterial.dispose&&this.strokeMaterial.dispose()}},{key:"remove",value:function(){this.map.off("projChanged",this.updatePostions),this.meshArea&&this.scene.remove(this.meshArea),this.meshArea&&this.meshArea.dispose&&this.meshArea.dispose(),this.geometryArea&&this.geometryArea.dispose&&this.geometryArea.dispose(),this.areaMaterial&&this.areaMaterial.dispose&&this.areaMaterial.dispose(),this.meshStroke&&this.scene.remove(this.meshStroke),this.meshStroke&&this.meshStroke.dispose&&this.meshStroke.dispose(),this.geometryStroke&&this.geometryStroke.dispose&&this.geometryStroke.dispose(),this.strokeMaterial&&this.strokeMaterial.dispose&&this.strokeMaterial.dispose(),this.areaData=null,this.geoJsonData=null,this.code2value=null,this.colorScale=null,this.meshArea=null,this.geometryArea=null,this.areaMaterial=null,this.meshStroke=null,this.geometryStroke=null,this.strokeMaterial=null}}]),b}(i);return a.exports=p,a.exports});