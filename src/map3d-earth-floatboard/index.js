const Cube = require('@/Cube')(module, module.exports, require);
Cube("datav:/com/map3d-earth-floatboard/0.0.15",["datav:/npm/eventemitter3/2.0.3"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=200,i=null,j=null,k=require("eventemitter3"),l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=Object.assign({visible:!0,opacity:1,scale:50,height:5,getLat:function(a){return void 0===a.lat?0:a.lat},getLng:function(a){return void 0===a.lng?0:a.lng},getContent:function(a){return void 0===a.content?{}:a.content}},c||{}),f.boardCollection=[],f}return f(b,a),g(b,[{key:"addTo",value:function(a){return a?void(i=a.THREE,j=a.Utils,this.map=a,this.scene=a.scene,this.map.on("projChanged",this.updatePostions.bind(this))):console.log("float board layer needs map layer")}},{key:"setData",value:function(a){return a&&Array.isArray(a)?Array.isArray(a)&&!a.length?(this.clean(),console.log("flyingline layer no data")):void(this.clean(),this.data=a,this.render()):console.log("float board layer no data")}},{key:"render",value:function(){for(var a=this.data,b=0;b<a.length;b++){var c=a[b],e=this.createBoard(c);this.scene.add(e),this.boardCollection.push({sprite:e,data:c})}this.checkVisible()}},{key:"createBoard",value:function(a){var b=this.options,c=b.opacity,d=b.getLat,e=b.getLng,f=b.getContent,g=e(a),k=d(a),l=f(a),m=l.width||900,n=l.height||300,o=document.createElement("canvas"),p=o.getContext("2d");o.width=m,o.height=n;var q=new i.CanvasTexture(o);q.anisotropy=this.map.renderer.getMaxAnisotropy();var r=this.material=new i.SpriteMaterial({map:q,opacity:c,transparent:!0,depthTest:!0});this.drawContent(p,l,q);var s=b.scale,t=this.sprite=new i.Sprite(r);t.renderOrder=1e4+Math.floor(100*Math.random()),t.scale.set(s,s*n/m,1);var u=this.map.Projection(g,k,h+b.height);return t.userData.spherePostion=j.ll2sphere(g,k,h+b.height),t.userData.planePostion=j.ll2plane(g,k,h+b.height),t.position.set(u.x,u.y,u.z),t}},{key:"drawContent",value:function(a,b,c){if(!b.bgImgUrl)this.drawText(a,b,c);else{var d=this,e=b.bgImgUrl,f=b.width||400,g=b.height||300,h=b.titleFontSize||0,j=h,k=new i.ImageLoader().setCrossOrigin("*");k.load(e,function(e){a.drawImage(e,0,j,f,g-j),d.drawText(a,b,c)})}}},{key:"drawText",value:function(a,b,c){var d=b.title||"",e=b.content||"",f=b.titleColor||"#FF0000",g=b.contentColor||"#000",h=b.width||400,k=b.height||300,l=b.titleFontSize||0,m=b.contentFontSize||0,n=b.fontFamily||"serif",o=b.paddingLeft||0,p=b.paddingRight||0,q=b.paddingTop||0;a.font=l+"px "+n,a.fillStyle=f,a.fillText(d,0,l),a.font=m+"px "+n,a.fillStyle=g;for(var r=0,s=0,t=1,u=0,i=e.length;u<i;u++){var j=e[u],v=this.isChinese(j)?m:0.5*m;if(r+=v,r>=(+(h-o-p)||1)||u===i-1){var w=e.slice(s,u+1);a.fillText(w,o,q+t*m),t++,s=u+1,r=0}}c.image=a.canvas,c.needsUpdate=!0}},{key:"getContentLength",value:function(a){if("string"!==typeof a)return 0;for(var b,c=0,d=0,e=a.length;d<e;d++)b=a[d],c+=this.isChinese(b)?1:0.5;return c}},{key:"isChinese",value:function(a){return null!==a.match(/[^\x00-\xff]/ig)}},{key:"updatePostions",value:function(a){var b=a.projType,c=a.index;if(0===b){if(this.boardCollection.length)for(var d=0;d<this.boardCollection.length;d++){var e=this.boardCollection[d].sprite,f=e.userData.spherePostion,g=e.userData.planePostion,h=f.x*c+(1-c)*g.x,i=f.y*c+(1-c)*g.y,j=f.z*c+(1-c)*g.z;e.position.set(h,i,j)}}else if(1===b&&this.boardCollection.length)for(var k=0;k<this.boardCollection.length;k++){var l=this.boardCollection[k].sprite,m=l.userData.spherePostion,n=l.userData.planePostion,o=n.x*c+(1-c)*m.x,p=n.y*c+(1-c)*m.y,q=n.z*c+(1-c)*m.z;l.position.set(o,p,q)}}},{key:"updateOptions",value:function(a){this.options=j.mergeOptions(this.options,a||{}),this.updateFloatBoard(),this.checkVisible()}},{key:"updateFloatBoard",value:function(){var a=this.options,b=a.scale,c=a.getLat,d=a.getLng,e=a.height,f=a.opacity,g=a.getContent;if(this.boardCollection.length)for(var j=0;j<this.boardCollection.length;j++){var i=this.boardCollection[j].sprite,k=this.boardCollection[j].data,l=g(k),m=l.width||900,n=l.height||300,o=this.map.Projection(d(k),c(k),e+h);i.position.set(o.x,o.y,o.z),i.scale.set(b,b*n/m,1),i.material.opacity=f,i.material.needsUpdate=!0}}},{key:"checkVisible",value:function(){var a=this.options;a.visible?this.show():this.hide()}},{key:"show",value:function(){if(this.options.visible=!0,this.boardCollection.length)for(var a,b=0;b<this.boardCollection.length;b++)a=this.boardCollection[b].sprite,a.visible=!0}},{key:"hide",value:function(){if(this.options.visible=!1,this.boardCollection.length)for(var a,b=0;b<this.boardCollection.length;b++)a=this.boardCollection[b].sprite,a.visible=!1}},{key:"clean",value:function(){if(this.boardCollection.length){for(var a,b=0;b<this.boardCollection.length;b++)a=this.boardCollection[b].sprite,this.scene.remove(a),a.dispose&&prite.dispose(),a.material&&a.material.dispose&&a.material.dispose(),this.boardCollection[b].data=null;this.boardCollection=[]}}},{key:"remove",value:function(){this.map.off("projChanged",this.updatePostions),this.clean(),this.data=null}}]),b}(k);return a.exports=l,a.exports});